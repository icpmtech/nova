
<!DOCTYPE html><html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perfil - Nova Hub</title>
  <style>
    /* ... [CSS unchanged] ... */
  </style>
</head>
<body>
  <!-- ... [HTML unchanged] ... -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script>
    // Firebase init
    firebase.initializeApp({ apiKey: "AIzaSyBhxtjdc14dv39mr_x_WuXouZrpMyGXpuk", authDomain: "novahub-8f4b0.firebaseapp.com", projectId: "novahub-8f4b0", storageBucket: "novahub-8f4b0.appspot.com", messagingSenderId: "619675546300", appId: "1:619675546300:web:7be9b40b4a5282772616b9" });
    const auth = firebase.auth(), storage = firebase.storage();// DOM
const profileImage   = document.getElementById('profileImage');
const profileName    = document.getElementById('profileName');
const profileEmail   = document.getElementById('profileEmail');
const loadingOverlay = document.getElementById('loadingOverlay');
const loadingText    = document.getElementById('loadingText');
const fileInputLabel = document.querySelector('.file-input-label span');
const navIcons       = document.querySelectorAll('.nav-icon');
const newNameInput   = document.getElementById('newName');
const newPhotoInput  = document.getElementById('newPhoto');
const submitBtn      = document.getElementById('submitBtn');

// Prevent duplicate toasts
const activeToasts = new Set();

function showLoading(msg='Carregando...') {
  loadingText.textContent = msg;
  loadingOverlay.classList.add('active');
}
function hideLoading() {
  loadingOverlay.classList.remove('active');
}

function showToast(msg, type='info', duration=5000) {
  // Skip if same toast is active
  if (activeToasts.has(msg)) return;
  activeToasts.add(msg);

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
  toast.innerHTML = `
    <span class="toast-icon">${icon}</span>
    <div class="toast-content">${msg}</div>
    <button class="toast-close">×</button>
  `;
  const container = document.getElementById('toastContainer');
  container.append(toast);
  setTimeout(() => toast.classList.add('show'), 10);

  const tid = setTimeout(() => closeToast(toast), duration);
  toast.querySelector('.toast-close').onclick = () => { clearTimeout(tid); closeToast(toast); };
}

function closeToast(toast) {
  const content = toast.querySelector('.toast-content');
  const msg = content ? content.textContent : null;
  toast.classList.remove('show');
  setTimeout(() => {
    toast.remove();
    if (msg) activeToasts.delete(msg);
  }, 300);
}

function toggleButtonLoading(btn, loading) {
  const loader = btn.querySelector('.btn-loader');
  if (loading) {
    loader.style.display = 'inline-block';
    btn.disabled = true;
    btn.style.opacity = '0.5';
    btn.style.cursor = 'wait';
  } else {
    loader.style.display = 'none';
    btn.disabled = false;
    btn.style.opacity = '1';
    btn.style.cursor = 'pointer';
  }
}

function updateTooltips(lang) {
  navIcons.forEach(icon => {
    const key = `tooltip${lang.toUpperCase()}`;
    const txt = icon.dataset[key] || icon.dataset.tooltipEn;
    icon.setAttribute('data-tooltip', txt);
  });
}

function checkChanges() {
  const hasChanges = newNameInput.value.trim() || newPhotoInput.files.length;
  submitBtn.disabled = !hasChanges;
  submitBtn.style.opacity = hasChanges ? '1' : '0.5';
}
newNameInput.oninput = checkChanges;
newPhotoInput.onchange = () => {
  const file = newPhotoInput.files[0];
  if (!file) {
    fileInputLabel.textContent = 'Selecionar imagem';
    checkChanges();
    return;
  }
  if (!file.type.startsWith('image/')) {
    showToast('Selecione imagem válida', 'error');
    newPhotoInput.value = '';
    return;
  }
  if (file.size > 2 * 1024 * 1024) {
    showToast('Máximo 2MB', 'error');
    newPhotoInput.value = '';
    return;
  }
  fileInputLabel.textContent = file.name.length > 20 ? file.name.slice(0, 17) + '...' : file.name;
  const reader = new FileReader();
  reader.onerror = () => { showToast('Erro ao ler arquivo', 'error'); newPhotoInput.value = ''; };
  reader.onload = e => document.getElementById('preview').innerHTML = `<img src="${e.target.result}" alt="Preview"/>`;
  reader.readAsDataURL(file);
  checkChanges();
};

// Auth state
showLoading('Carregando perfil...');
auth.onAuthStateChanged(async user => {
  try {
    if (!user) throw new Error('Não autenticado');
    profileName.textContent = user.displayName || 'Anônimo';
    profileEmail.textContent = user.email;
    profileImage.src = user.photoURL ? user.photoURL + `?t=${Date.now()}` : '/default-avatar.png';
    updateTooltips(document.querySelector('.language-btn.active').dataset.lang);
    showToast('Perfil carregado!', 'success', 3000);
  } catch (err) {
    showToast('Sessão expirada. Redirecionando...', 'info');
    setTimeout(() => location.href = 'login.html', 2000);
  } finally {
    hideLoading();
  }
});

document.getElementById('menuToggle').onclick = () => document.getElementById('sidebar').classList.toggle('active');
document.querySelectorAll('.language-btn').forEach(btn => btn.onclick = () => {
  document.querySelectorAll('.language-btn').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed', 'false'); });
  btn.classList.add('active');
  btn.setAttribute('aria-pressed', 'true');
  updateTooltips(btn.dataset.lang);
  showToast(`Idioma: ${btn.dataset.lang.toUpperCase()}`, 'info');
});

document.getElementById('logoutBtn').onclick = async function() {
  toggleButtonLoading(this, true);
  showToast('Encerrando...', 'info');
  try {
    await auth.signOut();
    showToast('Desconectado!', 'success');
    setTimeout(() => location.href = 'login.html', 1500);
  } catch (e) {
    showToast(`Erro: ${e.message}`, 'error');
    toggleButtonLoading(this, false);
  }
};

document.getElementById('homeBtn').onclick = () => {
  showToast('Início...', 'info');
  setTimeout(() => location.href = 'index.html', 800);
};

document.getElementById('editForm').onsubmit = async e => {
  e.preventDefault();
  const user = auth.currentUser;
  if (!user) return showToast('Sessão inválida', 'error');
  const name = newNameInput.value.trim();
  const file = newPhotoInput.files[0];
  toggleButtonLoading(submitBtn, true);
  showLoading('Atualizando...');
  try {
    if (file) {
      profileImage.classList.add('loading');
      const ref = storage.ref().child(`profileImages/${user.uid}_${Date.now()}`);
      await ref.put(file);
      const url = await ref.getDownloadURL();
      await user.updateProfile({ photoURL: url });
      profileImage.src = url + `?t=${Date.now()}`;
      showToast('Foto atualizada!', 'success');
    }
    if (name) {
      await user.updateProfile({ displayName: name });
      profileName.textContent = name;
      showToast('Nome atualizado!', 'success');
    }
    newNameInput.value = '';
    newPhotoInput.value = '';
    document.getElementById('preview').innerHTML = '';
    fileInputLabel.textContent = 'Selecionar imagem';
    checkChanges();
  } catch (err) {
    showToast(`Erro: ${err.message}`, 'error');
  } finally {
    profileImage.classList.remove('loading');
    hideLoading();
    toggleButtonLoading(submitBtn, false);
  }
};

profileImage.onerror = () => { profileImage.src = '/default-avatar.png'; showToast('Erro ao carregar imagem', 'error'); };

  </script>
</body>
</html>
